{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">

      <div class="card shadow-sm">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h3 class="mb-0">Feature Extractor</h3>
          </div>
          <p class="text-muted mb-3">Use sequences from the database or upload/paste your own. Feature extractor will compute length, k-mer frequencies (k=2,3), GC%, GC & AT/AU skew, and mononucleotide composition then visualize them with UMAP.</p>

          <form method="post" enctype="multipart/form-data" novalidate id="fxForm">
            {% csrf_token %}

            <!-- input mode -->
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label" for="{{ form.input_mode.id_for_label }}">Input source</label>
                {{ form.input_mode }}
                {% if form.input_mode.errors %}<div class="text-danger small">{{ form.input_mode.errors|join:", " }}</div>{% endif %}
              </div>
            </div>

            <!-- Database block -->
            <div class="mt-3 d-none" id="block-db">
              <label class="form-label">Choose databases</label>
              <div class="row row-cols-2 row-cols-md-3">
                {% for cb in form.db_types %}
                  <div class="col mb-2">
                    <div class="form-check">
                      {{ cb.tag }} <label class="form-check-label ms-1" for="{{ cb.id_for_label }}">{{ cb.choice_label }}</label>
                    </div>
                  </div>
                {% endfor %}
              </div>
              {% if form.db_types.errors %}<div class="text-danger small">{{ form.db_types.errors|join:", " }}</div>{% endif %}
            </div>

            <!-- Paste block -->
            <div class="mt-3 d-none" id="block-text">
              <label class="form-label" for="{{ form.sequences_text.id_for_label }}">Sequences</label>
              {{ form.sequences_text }}
              <div class="form-text">One per line, FASTA headers allowed.</div>
              {% if form.sequences_text.errors %}<div class="text-danger small">{{ form.sequences_text.errors|join:", " }}</div>{% endif %}
            </div>

            <!-- FASTA upload block -->
            <div class="mt-3 d-none" id="block-fasta">
              <label class="form-label" for="{{ form.file.id_for_label }}">Upload FASTA file</label>
              {{ form.file }}
              {% if form.file.errors %}<div class="text-danger small">{{ form.file.errors|join:", " }}</div>{% endif %}
            </div>

            <!-- CSV upload block -->
            <div class="mt-3 d-none" id="block-csv">
              <label class="form-label" for="{{ form.file.id_for_label }}">Upload CSV</label>
              {{ form.file }}
              <div class="form-text">CSV must include a column header named <code>sequence</code>.</div>
              {% if form.file.errors %}<div class="text-danger small">{{ form.file.errors|join:", " }}</div>{% endif %}
            </div>

            <!-- Feature -->
            <div class="mt-4">
              <label class="form-label">Features (for initial table/plot)</label>
              <div class="row row-cols-2 row-cols-md-3">
                {% for cb in form.features %}
                <div class="col mb-2">
                  <div class="form-check">
                    {{ cb.tag }} <label class="form-check-label ms-1" for="{{ cb.id_for_label }}">{{ cb.choice_label }}</label>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% if form.features.errors %}<div class="text-danger small">{{ form.features.errors|join:", " }}</div>{% endif %}
            </div>

            <div class="d-flex justify-content-end mt-4">
              <button class="btn btn-primary">Extract & Visualize</button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  (function () {
    const select = document.getElementById("{{ form.input_mode.auto_id }}");
    const blockText  = document.getElementById("block-text");
    const blockFasta = document.getElementById("block-fasta");
    const blockCsv   = document.getElementById("block-csv");
    const blockDb    = document.getElementById("block-db");

    function showBlock(mode) {
      [blockText, blockFasta, blockCsv, blockDb].forEach(el => el.classList.add("d-none"));
      if (mode === "text")  blockText.classList.remove("d-none");
      if (mode === "fasta") blockFasta.classList.remove("d-none");
      if (mode === "csv")   blockCsv.classList.remove("d-none");
      if (mode === "database") blockDb.classList.remove("d-none");
    }

    showBlock(select.value);
    select.addEventListener("change", function(){ showBlock(this.value); });
  })();
</script>
{% endblock %}
