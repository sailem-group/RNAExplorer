{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-end">
    <h2 class="mb-0">Feature Explorer Â· t-SNE</h2>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary"
                href="{% url 'feature_explorer_download_embeddings' %}">
                Download embeddings
      </a>
      <a href="{% url 'feature_explorer' %}" class="btn btn-outline-secondary">New exploration</a>
    </div>
  </div>
  <hr>
  <div id="tsnePlot" style="height:520px;"></div>
</div>

<script type="module">
  import Plotly from "https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.35.2/+esm";

  const PAYLOAD = {{ payload_json|safe }};

  const SEABORN_PANEL = "#E9F1FA";
  const GRID_COLOR    = "#FFFFFF";
  const AXIS_COLOR    = "#9aa4b2";
  const REF_STROKE = "#b0bec5";
  const refSymbolMap = { siRNA: "star", miRNA: "square", piRNA: "triangle-up" };

  const refTraces = [];
  for (const key of ["siRNA", "miRNA", "piRNA"]) {
    const ref = PAYLOAD.refs?.[key];
    if (!ref || !ref.xs?.length) continue;

    refTraces.push({
      name: `${key} ref (${ref.n})`,
      type: "scattergl",
      mode: "markers",
      x: ref.xs,
      y: ref.ys,
      hoverinfo: "skip",
      marker: {
        size: 7,
        color: "rgba(0,0,0,0)",
        opacity: 0.60,
        line: { width: 1.5, color: REF_STROKE },
        symbol: refSymbolMap[key] || "circle",
      },
      legendgroup: "refs",
    });
  }
  if (refTraces.length) {
    refTraces[0].legendgrouptitle = { text: "References" };
  }

  const U = PAYLOAD.user || {};
  const byGroup = {};
  const n = U.xs?.length || 0;
  const palette = U.group_palette || {};

  for (let i = 0; i < n; i++) {
    const g = (U.groups && U.groups[i]) || "All";
    if (!byGroup[g]) {
      byGroup[g] = {
        name: g,
        type: "scattergl",
        mode: "markers",
        x: [],
        y: [],
        text: [],
        hovertemplate: "%{text}<extra></extra>",
        marker: {
          size: 10,
          opacity: 0.95,
          line: { width: 0.6, color: "rgba(0,0,0,0.25)" },
          color: palette[g] || undefined,
          symbol: "circle"
        },
        legendgroup: "user"
      };
    }
    byGroup[g].x.push(U.xs[i]);
    byGroup[g].y.push(U.ys[i]);
    byGroup[g].text.push(`${U.names?.[i] || "sequence"} (${g})`);
  }
  for (const g in byGroup) {
    byGroup[g].name = `${g} (${byGroup[g].x.length})`;
  }
  const userTraces = Object.values(byGroup);
  if (userTraces.length) {
    userTraces[0].legendgrouptitle = { text: "Database / Type" };
  }

  // showing user legend first, then references
  const data = [...refTraces, ...userTraces];

  const layout = {
    template: "seaborn",
    paper_bgcolor: GRID_COLOR,
    plot_bgcolor: SEABORN_PANEL,
    margin: { l: 60, r: 170, t: 20, b: 60 },

    xaxis: {
      title: { text: "Dimension 1", standoff: 12 },
      showgrid: true,
      gridcolor: GRID_COLOR,
      gridwidth: 1.3,
      zeroline: false,
      linecolor: AXIS_COLOR,
      ticks: "outside",
      tickcolor: AXIS_COLOR,
      mirror: false,
    },
    yaxis: {
      title: { text: "Dimension 2", standoff: 12 },
      showgrid: true,
      gridcolor: GRID_COLOR,
      gridwidth: 1.3,
      zeroline: false,
      linecolor: AXIS_COLOR,
      ticks: "outside",
      tickcolor: AXIS_COLOR,
      mirror: false,
    },

    showlegend: true,
    legend: {
      title: undefined,
      orientation: "v",
      x: 1.3, xanchor: "right",
      y: 1, yanchor: "top",
      itemsizing: "constant",
      bgcolor: "#ffffff",
      bordercolor: "rgba(0,0,0,0.05)",
      borderwidth: 1,
      traceorder: "grouped+reversed",
    },

    hovermode: "closest",
  };

  const config = { responsive: true};

  Plotly.newPlot("tsnePlot", data, layout, config);
</script>

{% endblock %}
