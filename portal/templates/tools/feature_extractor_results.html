{% extends "base.html" %}
{% load custom_tags %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center">
    <h3 class="mb-3">Extraction Results</h3>
    <div class="d-flex gap-2">
      <a href="{% url 'feature_extractor_download' %}" class="btn btn-outline-secondary btn-sm">Download CSV</a>
      <a href="{% url 'feature_extractor' %}" class="btn btn-primary btn-sm">Run Again</a>
    </div>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-4">
        
        <div class="col-12 col-xl-5">
          <label class="form-label"><strong>Sequences to include</strong></label>

          <input id="seqSearch" type="search" class="form-control form-control-sm mb-2" placeholder="Search by name…">

          <div class="border rounded" style="max-height: 250px; overflow:auto; padding:.5rem;">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="form-check m-0">
                <input class="form-check-input" type="checkbox" id="seqAll">
                <label class="form-check-label fw-semibold" for="seqAll">Select all</label>
              </div>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" id="seqClear">Clear</button>
              </div>
            </div>
            <div id="seqList" class="d-grid gap-1"></div>
          </div>

          <div class="form-text">Hold Ctrl/⌘ or Shift to multi-select.</div>
        </div>

        <!-- Feature picker -->
        <div class="col-12 col-xl-7">
          <label class="form-label"><strong>Features used for UMAP</strong></label>

          <div class="fx-checkgrid" id="fx-feature-grid">

            <div class="form-check">
              <input class="form-check-input fxf" type="checkbox" id="f_length" data-key="length" checked>
              <label class="form-check-label" for="f_length">Length</label>
            </div>
            <div class="form-check">
              <input class="form-check-input fxf" type="checkbox" id="f_gc_pct" data-key="gc_pct" checked>
              <label class="form-check-label" for="f_gc_pct">GC %</label>
            </div>
            <div class="form-check">
              <input class="form-check-input fxf" type="checkbox" id="f_gc_skew" data-key="gc_skew" checked>
              <label class="form-check-label" for="f_gc_skew">GC skew</label>
            </div>
            <div class="form-check">
              <input class="form-check-input fxf" type="checkbox" id="f_at_au_skew" data-key="at_au_skew" checked>
              <label class="form-check-label" for="f_at_au_skew">AT/AU skew</label>
            </div>

            <div id="mncGridMount"></div>

            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="f_k2_group" checked>
              <label class="form-check-label" for="f_k2_group">K-mer (k=2)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="f_k3_group" checked>
              <label class="form-check-label" for="f_k3_group">K-mer (k=3)</label>
            </div>
          </div>

          <div class="row g-3 mt-3">
            <div class="col-12 col-md-6">
              <label class="form-label d-flex align-items-center gap-2 mb-1">
                <strong>Color by
                <span class="text-muted" data-bs-toggle="tooltip" title="You can color points by any feature to highlight on UMAP. Default is GC %.">ⓘ</span></strong>
              </label>
              <select id="colorBy" class="form-select form-select-sm"></select>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- UMAP -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h6 class="mb-3">UMAP projection</h6>
      <div id="umapPlot" style="width:100%;height:520px;"></div>
    </div>
  </div>

  <!-- Table -->
  <div class="card shadow-sm">
    <div class="card-body">
      <style>
        .fx-table { font-variant-numeric: tabular-nums; border-collapse: separate; border-spacing: 0; }
        thead th { white-space: nowrap; position: sticky; top: 0; background: var(--bs-light); z-index: 1; }
        td, th { vertical-align: middle; }
        .fx-num { text-align: right; white-space: nowrap; }
        .fx-seq {
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
          display: block; width: 100%;
          white-space: pre-wrap; word-break: break-word;
          max-height: 7rem; overflow: auto; margin: 0;
        }
        .fx-array {
          display: block;
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
          white-space: pre; overflow-x: auto; overflow-y: hidden; max-width: 100%; margin: 0;
        }
      </style>

      <div class="table-responsive" style="max-height:520px; overflow:auto;">
        <table class="table table-sm table-striped table-hover align-middle fx-table">
          <colgroup>
            {% for c in columns %}
              {% if c == 'name' %}<col style="width: 12ch;">
              {% elif c == 'sequence' %}<col style="width: 26rem;">
              {% elif c == 'length' %}<col style="width: 8ch;">
              {% elif c == 'gc_pct' or c == 'gc_skew' or c == 'at_au_skew' %}<col style="width: 10ch;">
              {% elif c|slice:':4' == 'mnc_' %}<col style="width: 10ch;">
              {% elif c == 'k2_values_str' or c == 'k3_values_str' %}<col style="width: 30rem;">
              {% else %}<col style="width: 12ch;">{% endif %}
            {% endfor %}
          </colgroup>

          <thead class="table-light">
            <tr>
              {% for h in headers %}
                <th>
                  {{ h }}
                  {% if h == "K-mer (k=2)" %}
                    <span class="ms-1 text-muted" data-bs-toggle="tooltip" title="{{ k2_labels_str }}">ⓘ</span>
                  {% elif h == "K-mer (k=3)" %}
                    <span class="ms-1 text-muted" data-bs-toggle="tooltip" title="{{ k3_labels_str }}">ⓘ</span>
                  {% endif %}
                </th>
              {% endfor %}
            </tr>
          </thead>

          <tbody>
            {% for r in results %}
              <tr>
                {% for c in columns %}
                  <td class="{% if c|is_numeric_col %}fx-num{% endif %}">
                    {% if c == 'sequence' %}
                      <code class="fx-seq">{{ r|get_item:c }}</code>
                    {% elif c == 'k2_values_str' or c == 'k3_values_str' %}
                      <code class="fx-array">{{ r|get_item:c }}</code>
                    {% else %}
                      {{ r|get_item:c }}
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <nav class="d-flex justify-content-between align-items-center mt-3" aria-label="Table pagination">
        <div class="small text-muted">
          <span id="fx-range"></span> of <span id="fx-total"></span>
        </div>
        <ul class="pagination mb-0" id="fx-pager">
          <li class="page-item"><button class="page-link" id="fx-prev">Prev</button></li>
          <li class="page-item disabled"><span class="page-link" id="fx-page">1</span></li>
          <li class="page-item"><button class="page-link" id="fx-next">Next</button></li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<script type="module">
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

  import { UMAP } from "https://cdn.jsdelivr.net/npm/umap-js@1.3.3/+esm";
  import Plotly from "https://cdn.jsdelivr.net/npm/plotly.js-dist-min@2.35.2/+esm";

  const payload  = {{ umap_payload_json|safe }};
  const rows     = payload.rows || [];
  const columns  = payload.columns || [];
  const k2Labels = payload.k2_labels || [];
  const k3Labels = payload.k3_labels || [];

  const ALL_KEYS = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
  const BASIC = ["length","gc_pct","gc_skew","at_au_skew"].filter(k => ALL_KEYS.includes(k));
  const MNC   = ALL_KEYS.filter(k => k.startsWith("mnc_")).sort();
  const K2    = ALL_KEYS.filter(k => k.startsWith("k2_")).sort();
  const K3    = ALL_KEYS.filter(k => k.startsWith("k3_")).sort();

  const mncMount = document.getElementById("mncGridMount");
  MNC.forEach(k => {
    const id = "f_" + k;
    const wrap = document.createElement("div");
    wrap.className = "form-check";
    wrap.innerHTML = `
      <input class="form-check-input fxf" type="checkbox" id="${id}" data-key="${k}" checked>
      <label class="form-check-label" for="${id}">MNC ${k.slice(4)}</label>
    `;
    mncMount.before(wrap);
  });
  mncMount.remove();

  const colorSelect = document.getElementById("colorBy");
  function addOpt(val, label){
    const o = document.createElement("option");
    o.value = val; o.textContent = label;
    colorSelect.appendChild(o);
  }
  (function buildColorOptions(){
    if (ALL_KEYS.includes("length"))       addOpt("length", "Length");
    if (ALL_KEYS.includes("gc_pct"))       addOpt("gc_pct", "GC %");
    if (ALL_KEYS.includes("gc_skew"))      addOpt("gc_skew", "GC skew");
    if (ALL_KEYS.includes("at_au_skew"))   addOpt("at_au_skew", "AT/AU skew");
    MNC.forEach(k => addOpt(k, `MNC ${k.slice(4)}`));
    if (K2.length) addOpt("k2_group", "K-mer (k=2)");
    if (K3.length) addOpt("k3_group", "K-mer (k=3)");
    if (colorSelect.options.length) colorSelect.value = "gc_pct";
  })();

  const selAll    = document.getElementById("seqAll");
  const seqList   = document.getElementById("seqList");
  const seqSearch = document.getElementById("seqSearch");

  function buildSeqList() {
    seqList.innerHTML = "";
    rows.forEach((r, i) => {
      const id = `seq_${i}`;
      const div = document.createElement("div");
      div.className = "form-check";
      div.innerHTML = `
        <input class="form-check-input seqChk" type="checkbox" id="${id}" data-idx="${i}" checked>
        <label class="form-check-label" for="${id}">${r.name || `Seq ${i+1}`}</label>
      `;
      seqList.appendChild(div);
    });
    selAll.indeterminate = false;
    selAll.checked = true;
  }
  buildSeqList();

  function selectedIdxs() {
    return [...document.querySelectorAll(".seqChk")]
      .filter(cb => cb.checked)
      .map(cb => Number(cb.dataset.idx));
  }
  function ensureAtLeastOne() {
    const boxes = [...document.querySelectorAll(".seqChk")];
    if (boxes.every(b => !b.checked) && boxes.length) boxes[0].checked = true;
  }
  function updateSelAllState() {
    const boxes = [...document.querySelectorAll(".seqChk")];
    const nChecked = boxes.filter(b => b.checked).length;
    selAll.indeterminate = false;
    selAll.checked = nChecked === boxes.length;
  }

  // toggle
  selAll.addEventListener("change", () => {
    const boxes = [...document.querySelectorAll(".seqChk")];
    if (selAll.checked) {
      boxes.forEach(b => (b.checked = true));
    } else {
      boxes.forEach(b => (b.checked = false));
      if (boxes.length) boxes[0].checked = true;
    }
    runOrHighlight();
  });

  let lastClickedIdx = null;

  seqList.addEventListener("click", (e) => {
    if (!e.target.classList.contains("seqChk")) return;

    const boxes = [...document.querySelectorAll(".seqChk")];
    const idx   = Number(e.target.dataset.idx);
    const isMeta = e.metaKey || e.ctrlKey; // Cmd (mac) or Ctrl (win/linux)
    const isShift = e.shiftKey;

    if (!isMeta && !isShift) {
      boxes.forEach((b, i) => (b.checked = i === idx));
    }

    if (isShift && lastClickedIdx !== null && Number.isFinite(lastClickedIdx)) {
      const [a, b] = idx >= lastClickedIdx ? [lastClickedIdx, idx] : [idx, lastClickedIdx];
      const makeChecked = e.target.checked; // state after the click
      for (let i = a; i <= b; i++) boxes[i].checked = makeChecked;
    }

    if (boxes.every(b => !b.checked) && boxes.length) {
      boxes[idx].checked = true;
    }

    updateSelAllState();
    runOrHighlight();

    lastClickedIdx = idx;
  });

  // search filter
  seqSearch.addEventListener("input", () => {
    const q = seqSearch.value.toLowerCase();
    [...seqList.querySelectorAll(".form-check")].forEach(div => {
      const name = div.querySelector("label")?.textContent?.toLowerCase() || "";
      div.style.display = name.includes(q) ? "" : "none";
    });
  });

  function selectedFeatureKeys() {
    const keys = [];
    document.querySelectorAll(".fxf").forEach(cb => { if (cb.checked && cb.dataset.key) keys.push(cb.dataset.key); });
    if (document.getElementById("f_k2_group")?.checked) keys.push(...K2);
    if (document.getElementById("f_k3_group")?.checked) keys.push(...K3);
    return keys.length ? keys : BASIC;
  }
  const vectorize = (r, keys) => keys.map(k => {
    const n = Number(r[k]); return Number.isFinite(n) ? n : 0;
  });
  function computeColorVector(sel, mode){
    if (!mode) return null;
    if (mode === "k2_group" && K2.length) return sel.map(r => Math.max(...K2.map(k => Number(r[k]) || 0)));
    if (mode === "k3_group" && K3.length) return sel.map(r => Math.max(...K3.map(k => Number(r[k]) || 0)));
    return sel.map(r => Number.isFinite(Number(r[mode])) ? Number(r[mode]) : 0);
  }
  function prettyTitle(mode){
    if (!mode) return "";
    if (mode === "k2_group") return "K-mer (k=2)";
    if (mode === "k3_group") return "K-mer (k=3)";
    if (mode.startsWith("mnc_")) return `MNC ${mode.slice(4)}`;
    if (mode === "gc_pct") return "GC %";
    if (mode === "gc_skew") return "GC skew";
    if (mode === "at_au_skew") return "AT/AU skew";
    if (mode === "length") return "Length";
    return mode;
  }

  function mulberry32(seed) {
    let t = seed >>> 0;
    return function () {
      t += 0x6D2B79F5;
      let r = Math.imul(t ^ (t >>> 15), 1 | t);
      r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
      return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
    };
  }
  function hashString(s) {
    let h = 2166136261;
    for (let i = 0; i < s.length; i++) { h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
    return h >>> 0;
  }

  // UMAP
  let baseEmbedding = null;
  let lastSubset = null;  

  function buildBaseEmbedding() {
    const keys = selectedFeatureKeys();
    if (!rows.length || !keys.length) {
      baseEmbedding = { xs: [], ys: [], labels: [] };
      return;
    }
    if (rows.length === 1) { baseEmbedding = { xs:[0], ys:[0], labels:[rows[0].name] }; return; }
    if (rows.length === 2) { baseEmbedding = { xs:[-0.5,0.5], ys:[0,0], labels: rows.map(r=>r.name) }; return; }

    const X = rows.map(r => vectorize(r, keys));
    const nNeighbors = Math.max(2, Math.min(15, X.length - 1));
    const seed = hashString(JSON.stringify(rows.map(r=>r.name)));
    const rng  = mulberry32(seed);
    const umap = new UMAP({ nNeighbors, minDist:0.1, nComponents:2, metric:"euclidean", init:"spectral", random:rng });
    const emb  = umap.fit(X);
    baseEmbedding = {
      xs: emb.map(p=>p[0]),
      ys: emb.map(p=>p[1]),
      labels: rows.map(r=>r.name)
    };
  }

  function recolorOnly(){
    const figs = document.getElementById("umapPlot");
    if (!figs || !figs.data || !figs.data.length) return;

    const mode  = colorSelect?.value;
    const title = prettyTitle(mode);
    const baseCvec = computeColorVector(rows, mode);

    Plotly.restyle('umapPlot', {
      'marker.color': [baseCvec],
      'marker.colorscale': ['Viridis'],
      'marker.showscale': [true],
      'marker.colorbar.title.text': [title],
      'hovertemplate': [mode ? `%{text}<br>${title}: %{marker.color:.4f}<extra></extra>` : "%{text}<extra></extra>`"]
    }, 0);

    if (figs.data.length > 1 && figs.data[1].customdata && baseCvec) {
      const idx = figs.data[1].customdata[0];
      Plotly.restyle('umapPlot', { 'marker.color': [[ baseCvec[idx] ]] }, 1);
    }
  }
  colorSelect?.addEventListener('change', recolorOnly);

  function renderAllWithOptionalHighlight(highlightIdx) {
    const mode  = document.getElementById("colorBy")?.value;
    const title = prettyTitle(mode);
    const cvec  = computeColorVector(rows, mode);

    const baseTrace = {
      x: baseEmbedding.xs, y: baseEmbedding.ys, mode:'markers', type:'scattergl',
      text: baseEmbedding.labels,
      hovertemplate: mode ? `%{text}<br>${title}: %{marker.color:.4f}<extra></extra>` : "%{text}<extra></extra>",
      marker: cvec ? { size:8, color:cvec, colorscale:'Viridis', showscale:true, colorbar:{ title:{ text:title } } } : { size:8 }
    };

    if (highlightIdx == null) {
      Plotly.react("umapPlot", [baseTrace], {
        margin:{l:0,r:0,t:0,b:0}, xaxis:{zeroline:true, showgrid:true}, yaxis:{zeroline:true, showgrid:true}
      });
      return;
    }

    const hx = baseEmbedding.xs[highlightIdx];
    const hy = baseEmbedding.ys[highlightIdx];
    const htrace = {
      x:[hx], y:[hy], mode:'markers', type:'scattergl',
      text:[rows[highlightIdx].name],
      hovertemplate:"%{text}<extra></extra>",
      marker:{ size:14, symbol:'diamond-open', line:{ width:2, color:'black' },
               color: cvec ? [cvec[highlightIdx]] : undefined },
      showlegend:false,
      customdata:[[highlightIdx]]
    };

    Plotly.react("umapPlot", [baseTrace, htrace], {
      margin:{l:0,r:0,t:0,b:0}, xaxis:{zeroline:true, showgrid:true}, yaxis:{zeroline:true, showgrid:true}
    });
  }

  function renderSubsetUMAP(subsetRows) {
    const keys = selectedFeatureKeys();
    if (!subsetRows.length || !keys.length) {
      return Plotly.react("umapPlot", [], { margin:{l:0,r:0,t:0,b:0} });
    }
    if (subsetRows.length === 1) return renderAllWithOptionalHighlight(rows.indexOf(subsetRows[0]));
    if (subsetRows.length === 2) {
      const labels = subsetRows.map(r=>r.name);
      const mode = document.getElementById("colorBy")?.value;
      const cvec = computeColorVector(subsetRows, mode);
      const title = prettyTitle(mode);
      const trace = {
        x:[-0.5,0.5], y:[0,0], mode:'markers', type:'scattergl', text:labels,
        hovertemplate: mode ? `%{text}<br>${title}: %{marker.color:.4f}<extra></extra>` : "%{text}<extra></extra>",
        marker: cvec ? { size:8, color:cvec, colorscale:'Viridis', showscale:true, colorbar:{ title:{ text:title } } } : { size:8 }
      };
      return Plotly.react("umapPlot", [trace], {
        margin:{l:0,r:0,t:0,b:0}, xaxis:{zeroline:true, showgrid:true}, yaxis:{zeroline:true, showgrid:true}
      });
    }

    const X = subsetRows.map(r => vectorize(r, keys));
    const nNeighbors = Math.max(2, Math.min(15, X.length - 1));
    const seed = hashString(JSON.stringify(subsetRows.map(r=>r.name)));
    const rng  = mulberry32(seed);
    const umap = new UMAP({ nNeighbors, minDist:0.1, nComponents:2, metric:'euclidean', init:'spectral', random:rng });
    const emb  = umap.fit(X);
    const xs = emb.map(p=>p[0]); const ys = emb.map(p=>p[1]);
    const labels = subsetRows.map(r=>r.name);
    const mode = document.getElementById("colorBy")?.value;
    const cvec = computeColorVector(subsetRows, mode);
    const title = prettyTitle(mode);

    lastSubset = { xs, ys, labels, selRows: subsetRows };
    const trace = {
      x: xs, y: ys, mode:'markers', type:'scattergl', text: labels,
      hovertemplate: mode ? `%{text}<br>${title}: %{marker.color:.4f}<extra></extra>` : "%{text}<extra></extra>",
      marker: cvec ? { size:8, color:cvec, colorscale:'Viridis', showscale:true, colorbar:{ title:{ text:title } } } : { size:8 }
    };
    Plotly.react("umapPlot", [trace], {
      margin:{l:0,r:0,t:0,b:0}, xaxis:{zeroline:true, showgrid:true}, yaxis:{zeroline:true, showgrid:true}
    });
  }

  function runOrHighlight() {
    const idxs = selectedIdxs();
    if (!baseEmbedding) buildBaseEmbedding();
    if (idxs.length === 1) {
      renderAllWithOptionalHighlight(idxs[0]);
    } else {
      const subset = idxs.length ? idxs.map(i => rows[i]) : rows;
      renderSubsetUMAP(subset);
    }
  }

  function rerunForFeatureChange() {
    baseEmbedding = null;
    buildBaseEmbedding();
    runOrHighlight();
  }

  // Wireing up feature toggles + Update button
  document.querySelectorAll(".fxf, #f_k2_group, #f_k3_group").forEach(cb => {
    cb.addEventListener("change", rerunForFeatureChange);
  });

  // Initial draw
  buildBaseEmbedding();
  runOrHighlight();

  document.getElementById("seqClear")?.addEventListener("click", (e) => {
    e.preventDefault();
    const boxes = [...document.querySelectorAll(".seqChk")];
    boxes.forEach(b => b.checked = false);
    if (boxes.length) boxes[0].checked = true;
    selAll.indeterminate = false;
    selAll.checked = false;
    runOrHighlight();
  });

  // table pagination
  (function(){
    const PAGE_SIZE = 15;
    const table = document.querySelector('.fx-table');
    if (!table) return;
    const tbody = table.querySelector('tbody');
    if (!tbody) return;

    const trList = Array.from(tbody.querySelectorAll('tr'));
    const total = trList.length;
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));

    const elPrev  = document.getElementById('fx-prev');
    const elNext  = document.getElementById('fx-next');
    const elPage  = document.getElementById('fx-page');
    const elRange = document.getElementById('fx-range');
    const elTotal = document.getElementById('fx-total');

    elTotal.textContent = String(total);
    let page = 1;

    function renderPage(p){
      page = Math.min(Math.max(1, p), totalPages);
      trList.forEach(r => r.style.display = 'none');
      const start = (page - 1) * PAGE_SIZE;
      const end   = Math.min(start + PAGE_SIZE, total);
      for (let i = start; i < end; i++) trList[i].style.display = '';
      elPage.textContent = String(page);
      elPrev.parentElement.classList.toggle('disabled', page <= 1);
      elNext.parentElement.classList.toggle('disabled', page >= totalPages);
      elRange.textContent = total ? `${start + 1}-${end}` : '0-0';
    }

    elPrev.addEventListener('click', (e) => { e.preventDefault(); if (page > 1) renderPage(page - 1); });
    elNext.addEventListener('click', (e) => { e.preventDefault(); if (page < totalPages) renderPage(page + 1); });

    renderPage(1);
  })();
</script>

{% endblock %}
